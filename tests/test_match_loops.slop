;; Test: for and for-each loops inside match branch bodies

(module test-match-loops

  (fn test-for-in-match ((opt (Option Int)))
    (@intent "Test for loop inside match branch body")
    (@spec (((Option Int)) -> Int))
    (let ((mut sum 0))
      (match opt
        ((some n)
          (for (i 0 n)
            (set! sum (+ sum 1))))
        ((none) (do)))
      sum))

  (fn test-for-each-in-match ()
    (@intent "Test for-each over list inside match branch body")
    (@spec (() -> Int))
    (with-arena 4096
      (let ((items (list-new arena Int))
            (opt (Option Int) (some 1))
            (mut total 0))
        (list-push items 10)
        (list-push items 20)
        (list-push items 30)
        (match opt
          ((some _)
            (for-each (x items)
              (set! total (+ total x))))
          ((none) (do)))
        total)))

  (fn test-for-in-match-none ()
    (@intent "Test for loop in match none branch is not reached")
    (@spec (() -> Int))
    (let ((opt (Option Int) none)
          (mut sum 0))
      (match opt
        ((some n)
          (for (i 0 n)
            (set! sum (+ sum 1))))
        ((none) (set! sum 99)))
      sum))

  (fn test-return-in-for-in-match ((opt (Option Int)))
    (@intent "Test return inside for loop inside match branch")
    (@spec (((Option Int)) -> Int))
    (match opt
      ((some n)
        (let ((mut sum 0))
          (for (i 0 n)
            (set! sum (+ sum i)))
          (return sum)))
      ((none) (return -1))))

  (fn main ()
    (@intent "Run match-with-loops tests")
    (@spec (() -> Int))
    (let ((mut failures 0))
      (if (== (test-for-in-match (some 5)) 5)
        (println "test-for-in-match some: PASS")
        (do (println "test-for-in-match some: FAIL")
            (set! failures (+ failures 1))))
      (if (== (test-for-in-match none) 0)
        (println "test-for-in-match none: PASS")
        (do (println "test-for-in-match none: FAIL")
            (set! failures (+ failures 1))))
      (if (== (test-for-each-in-match) 60)
        (println "test-for-each-in-match: PASS")
        (do (println "test-for-each-in-match: FAIL")
            (set! failures (+ failures 1))))
      (if (== (test-for-in-match-none) 99)
        (println "test-for-in-match-none: PASS")
        (do (println "test-for-in-match-none: FAIL")
            (set! failures (+ failures 1))))
      (if (== (test-return-in-for-in-match (some 5)) 10)
        (println "test-return-in-for-in-match some: PASS")
        (do (println "test-return-in-for-in-match some: FAIL")
            (set! failures (+ failures 1))))
      (if (== (test-return-in-for-in-match none) -1)
        (println "test-return-in-for-in-match none: PASS")
        (do (println "test-return-in-for-in-match none: FAIL")
            (set! failures (+ failures 1))))
      (if (== failures 0)
        0
        1))))
