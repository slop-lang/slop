;; ============================================================
;; Phase 5 Tests: cond, for, for-each statements
;; ============================================================

(module test-phase5

  ;; ============================================================
  ;; cond tests
  ;; ============================================================

  (fn test-cond-first ((x Int))
    (@intent "Test cond matching first clause")
    (@spec ((Int) -> Int))
    (cond
      ((< x 0) -1)
      ((== x 0) 0)
      (else 1)))

  (fn test-cond-middle ((x Int))
    (@intent "Test cond matching middle clause")
    (@spec ((Int) -> Int))
    (cond
      ((< x 0) -1)
      ((== x 0) 0)
      (else 1)))

  (fn test-cond-else ((x Int))
    (@intent "Test cond matching else clause")
    (@spec ((Int) -> Int))
    (cond
      ((< x 0) -1)
      ((== x 0) 0)
      (else 1)))

  (fn test-cond-multi-stmt ((x Int))
    (@intent "Test cond with multiple statements in body")
    (@spec ((Int) -> Int))
    (let ((mut result 0))
      (cond
        ((< x 0)
          (set! result -1)
          (set! result (- result 1)))
        ((== x 0)
          (set! result 0))
        (else
          (set! result 1)
          (set! result (+ result 1))))
      result))

  (fn test-cond-no-else ((x Int))
    (@intent "Test cond without else clause")
    (@spec ((Int) -> Int))
    (let ((mut result 99))
      (cond
        ((< x 0) (set! result -1))
        ((== x 0) (set! result 0)))
      result))

  ;; ============================================================
  ;; for loop tests
  ;; ============================================================

  (fn test-for-sum ()
    (@intent "Test for loop summing 0 to 9")
    (@spec (() -> Int))
    (let ((mut sum 0))
      (for (i 0 10)
        (set! sum (+ sum i)))
      sum))

  (fn test-for-nested ()
    (@intent "Test nested for loops")
    (@spec (() -> Int))
    (let ((mut count 0))
      (for (i 0 3)
        (for (j 0 4)
          (set! count (+ count 1))))
      count))

  (fn test-for-expr-bounds ()
    (@intent "Test for loop with expression bounds")
    (@spec (() -> Int))
    (let ((start 5)
          (end 10)
          (mut sum 0))
      (for (i start end)
        (set! sum (+ sum i)))
      sum))

  (fn test-for-zero-iterations ()
    (@intent "Test for loop with zero iterations")
    (@spec (() -> Int))
    (let ((mut sum 100))
      (for (i 10 10)
        (set! sum (+ sum 1)))
      sum))

  (fn test-for-single-iteration ()
    (@intent "Test for loop with single iteration")
    (@spec (() -> Int))
    (let ((mut sum 0))
      (for (i 0 1)
        (set! sum (+ sum i)))
      sum))

  ;; ============================================================
  ;; Combined tests
  ;; ============================================================

  (fn test-for-with-cond ()
    (@intent "Test for loop with cond inside")
    (@spec (() -> Int))
    (let ((mut evens 0)
          (mut odds 0))
      (for (i 0 10)
        (cond
          ((== (% i 2) 0) (set! evens (+ evens 1)))
          (else (set! odds (+ odds 1)))))
      (+ evens odds)))

  (fn test-cond-return ((x Int))
    (@intent "Test cond as return expression")
    (@spec ((Int) -> Int))
    (cond
      ((< x 0) (* x -1))
      (else x)))

  ;; ============================================================
  ;; Main runner
  ;; ============================================================

  (fn main ()
    (@intent "Run Phase 5 statement tests")
    (@spec (() -> Int))
    (let ((mut passed 0)
          (mut failed 0))

      ;; cond tests
      (if (== (test-cond-first -5) -1)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-middle 0) 0)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-else 5) 1)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-multi-stmt -3) -2)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-multi-stmt 0) 0)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-multi-stmt 7) 2)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-no-else 5) 99)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      ;; for tests
      (if (== (test-for-sum) 45)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-for-nested) 12)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-for-expr-bounds) 35)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-for-zero-iterations) 100)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-for-single-iteration) 0)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      ;; Combined tests
      (if (== (test-for-with-cond) 10)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-return 5) 5)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      (if (== (test-cond-return -3) 3)
        (set! passed (+ passed 1))
        (set! failed (+ failed 1)))

      ;; Return 0 if all passed, 1 otherwise
      (if (== failed 0)
        0
        1))))
